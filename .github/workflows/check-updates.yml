name: CAAC Regulation Update Check

on:
  schedule:
    # Daily at UTC 7:00 (Beijing Time 15:00)
    # Beijing Time = UTC + 8
    #   Beijing 8:00  → UTC 0:00  → cron: '0 0 * * *'
    #   Beijing 15:00 → UTC 7:00  → cron: '0 7 * * *'
    #   Beijing 20:00 → UTC 12:00 → cron: '0 12 * * *'
    - cron: '0 7 * * *'
  workflow_dispatch:  # Allow manual trigger

# Prevent concurrent runs
concurrency:
  group: caac-check
  cancel-in-progress: true

jobs:
  check-updates:
    runs-on: ubuntu-22.04
    
    permissions:
      contents: write  # Required for committing state file
      actions: write   # Clean up old workflow runs
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Set up Python
        run: uv python install 3.12
      
      - name: Install dependencies
        run: uv sync
      
      # Install Patchright browser (anti-detection)
      # --with-deps installs system dependencies (libgbm, libasound2, etc.)
      - name: Install Patchright browsers
        run: uv run patchright install --with-deps chromium
      
      - name: Run check
        env:
          # Playwright/Patchright timeout (CI needs longer)
          PLAYWRIGHT_TIMEOUT: "60000"
          
          # Send regulations from last N days (empty = detect new)
          DAYS: ${{ secrets.DAYS }}
          
          # Notification - Email
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          
          # Notification - PushPlus
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          
          # Notification - Telegram
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          uv run python -m src.main --notify ${{ secrets.NOTIFY || '0' }}
      
      - name: Commit state update
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/regulations.json
          git diff --staged --quiet || git commit -m "chore: update regulation state $(date +'%Y-%m-%d')"
          git push
      
      - name: Upload downloaded files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: downloaded-regulations-${{ github.run_number }}
          path: downloads/
          retention-days: 30
          if-no-files-found: ignore
      
      # Clean up old workflow runs
      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 10
          keep_minimum_runs: 6
