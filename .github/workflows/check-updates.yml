name: CAAC Regulation Update Check

on:
  schedule:
    # Daily at UTC 7:00 (Beijing Time 15:00)
    # Beijing Time = UTC + 8
    #   Beijing 8:00  ‚Üí UTC 0:00  ‚Üí cron: '0 0 * * *'
    #   Beijing 15:00 ‚Üí UTC 7:00  ‚Üí cron: '0 7 * * *'
    #   Beijing 20:00 ‚Üí UTC 12:00 ‚Üí cron: '0 12 * * *'
    - cron: '0 7 * * *'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      categories:
        description: |
          Ë¶ÅÁõëÊéßÁöÑÂàÜÁ±ªIDÔºàÈÄóÂè∑ÂàÜÈöîÔºâÔºåÁïôÁ©∫ = ÂÖ®ÈÉ®ÂàÜÁ±ª
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ ID  ‚îÇ ÂàÜÁ±ªÂêçÁß∞         ‚îÇ
          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
          ‚îÇ  9  ‚îÇ ÈÄöÁü•ÂÖ¨Âëä         ‚îÇ
          ‚îÇ 10  ‚îÇ ÊîøÁ≠ñÂèëÂ∏É         ‚îÇ
          ‚îÇ 11  ‚îÇ ÊîøÁ≠ñËß£ËØª         ‚îÇ
          ‚îÇ 12  ‚îÇ ÁªüËÆ°Êï∞ÊçÆ         ‚îÇ
          ‚îÇ 47  ‚îÇ Ê≥ïÂæãÊ≥ïËßÑ         ‚îÇ
          ‚îÇ 13  ‚îÇ Ê∞ëËà™ËßÑÁ´†         ‚îÇ
          ‚îÇ 14  ‚îÇ ËßÑËåÉÊÄßÊñá‰ª∂       ‚îÇ
          ‚îÇ 15  ‚îÇ Ê†áÂáÜËßÑËåÉ         ‚îÇ
          ‚îÇ 16  ‚îÇ ÂØπÂ§ñÂÖ≥Á≥ª         ‚îÇ
          ‚îÇ 17  ‚îÇ Ê∏ØÊæ≥Âè∞Âêà‰Ωú       ‚îÇ
          ‚îÇ 18  ‚îÇ ÂõΩÈôÖÂÖ¨Á∫¶         ‚îÇ
          ‚îÇ 19  ‚îÇ ‰∫∫‰∫ã‰ø°ÊÅØ         ‚îÇ
          ‚îÇ 20  ‚îÇ Ë¥¢Êîø‰ø°ÊÅØ         ‚îÇ
          ‚îÇ 21  ‚îÇ ÂèëÂ±ïËßÑÂàí         ‚îÇ
          ‚îÇ 22  ‚îÇ ÈáçÂ§ßÈ°πÁõÆ         ‚îÇ
          ‚îÇ 23  ‚îÇ Ë°åÊîøÊùÉÂäõ         ‚îÇ
          ‚îÇ 24  ‚îÇ ÊîøÂ∫úÂÖ¨Êñá         ‚îÇ
          ‚îÇ 25  ‚îÇ Êú∫ÊûÑËÅåËÉΩ         ‚îÇ
          ‚îÇ 26  ‚îÇ ÂØπÂ§ñÊîøÁ≠ñ         ‚îÇ
          ‚îÇ 27  ‚îÇ ÊâßÊ≥ïÂÖ∏ÂûãÊ°à‰æã     ‚îÇ
          ‚îÇ 28  ‚îÇ Âª∫ËÆÆÊèêÊ°àÁ≠îÂ§ç     ‚îÇ
          ‚îÇ 29  ‚îÇ ÊîøÂ∫úÁΩëÁ´ôÂπ¥Â∫¶Êä•Ë°® ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          Á§∫‰æã: 9,13,14,15
        required: false
        type: string
        default: ''
      days:
        description: |
          ÂèëÈÄÅÊúÄËøë N Â§©ÂÜÖÁöÑÊñá‰ª∂Ôºà0 ÊàñÁïôÁ©∫ = Â¢ûÈáèÊ£ÄÊµãÊñ∞Êñá‰ª∂Ôºâ
        required: false
        type: string
        default: ''
      notify:
        description: 'ÊòØÂê¶Âº∫Âà∂ÂèëÈÄÅÈÄöÁü•: 1=ÂßãÁªàÂèëÈÄÅ, 0=‰ªÖÊúâÊñ∞Êñá‰ª∂Êó∂ÂèëÈÄÅ'
        required: false
        type: choice
        options:
          - '1'
          - '0'
        default: '1'

# Prevent concurrent runs
concurrency:
  group: caac-check
  cancel-in-progress: true

jobs:
  check-updates:
    runs-on: ubuntu-22.04

    permissions:
      contents: write  # Required for committing state file
      actions: write   # Clean up old workflow runs

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync

      # Install Patchright browser (anti-detection)
      # --with-deps installs system dependencies (libgbm, libasound2, etc.)
      - name: Install Patchright browsers
        run: uv run patchright install --with-deps chromium

      - name: Run check
        env:
          # Playwright/Patchright timeout (CI needs longer)
          PLAYWRIGHT_TIMEOUT: "60000"

          # Send regulations from last N days (empty = detect new)
          # ÊâãÂä®Ëß¶ÂèëÊó∂‰ºòÂÖàÁî® github.event.inputsÔºåÂÆöÊó∂‰ªªÂä°Áî® secrets
          DAYS: ${{ github.event.inputs.days || secrets.DAYS }}

          # Notification - Email
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}

          # Notification - PushPlus
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}

          # Notification - Telegram
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

          # Cloudflare R2 (optional, for PDF hosting via Worker proxy)
          R2_WORKER_URL: ${{ secrets.R2_WORKER_URL }}
          R2_WORKER_SECRET: ${{ secrets.R2_WORKER_SECRET }}
          R2_DOMAIN: ${{ secrets.R2_DOMAIN }}
        run: |
          # ÊûÑÂª∫ÂëΩ‰ª§ÂèÇÊï∞
          CMD=(uv run python -m src.main)

          # --categories: ÊâãÂä®Ëß¶ÂèëÊó∂Áî® github.event.inputsÔºåÂÆöÊó∂‰ªªÂä°Áî® secretsÔºàÈÉΩÂèØÈÄâÔºâ
          CATS="${{ github.event.inputs.categories || secrets.CATEGORIES }}"
          if [ -n "$CATS" ]; then
            CMD+=(--categories "$CATS")
          fi

          # --notify: ÊâãÂä®Ëß¶ÂèëÊó∂Áî® github.event.inputsÔºåÂÆöÊó∂‰ªªÂä°Áî® secrets
          CMD+=(--notify "${{ github.event.inputs.notify || secrets.NOTIFY || '1' }}")

          # Âõ∫ÂÆöÊØè‰∏™ÂàÜÁ±ªÊäìÂèñÊù°Êï∞ÔºåÊèêÈ´ò JS Êõ¥Êñ∞Ë¶ÜÁõñÁéá
          CMD+=(--perpage 200)

          echo "Running: ${CMD[*]}"
          "${CMD[@]}"

      - name: Commit state update
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/regulations.json
          if [ -f data/downloads.json ]; then
            git add data/downloads.json
          fi
          if [ -f data/r2_uploads.json ]; then
            git add data/r2_uploads.json
          fi
          if [ -d JS ]; then
            shopt -s nullglob
            js_files=(JS/*.js)
            if [ ${#js_files[@]} -gt 0 ]; then
              git add "${js_files[@]}"
            fi
          fi
          # downloads/ no longer committed to repo ‚Äî PDFs hosted on R2 only
          git diff --staged --quiet || git commit -m "chore: update regulation state $(date +'%Y-%m-%d')"
          git push

      # Sync JS data files to FlightToolbox miniprogram
      # Pushes regulation.js / normative.js / specification.js ‚Üí triggers WeChat CI
      - name: Sync JS to FlightToolbox
        env:
          FLIGHTTOOLBOX_TOKEN: ${{ secrets.FLIGHTTOOLBOX_TOKEN }}
        run: |
          if [ -z "$FLIGHTTOOLBOX_TOKEN" ]; then
            echo "‚è≠Ô∏è FLIGHTTOOLBOX_TOKEN not set, skipping sync"
            exit 0
          fi
          if [ ! -d JS ] || [ -z "$(ls JS/*.js 2>/dev/null)" ]; then
            echo "‚è≠Ô∏è No JS files to sync"
            exit 0
          fi

          REPO_URL="https://x-access-token:${FLIGHTTOOLBOX_TOKEN}@github.com/wangwingzero/FlightToolbox.git"
          CLONE_DIR="/tmp/FlightToolbox"
          TARGET_DIR="miniprogram/packageCCAR"

          git clone --depth 1 "$REPO_URL" "$CLONE_DIR"

          CHANGED=0
          for js_file in JS/*.js; do
            filename=$(basename "$js_file")
            target="$CLONE_DIR/$TARGET_DIR/$filename"
            if [ -f "$target" ]; then
              if ! diff -q "$js_file" "$target" > /dev/null 2>&1; then
                cp "$js_file" "$target"
                echo "üìù Updated: $filename"
                CHANGED=1
              else
                echo "‚úÖ No change: $filename"
              fi
            else
              cp "$js_file" "$target"
              echo "üìù New file: $filename"
              CHANGED=1
            fi
          done

          if [ "$CHANGED" -eq 0 ]; then
            echo "‚è≠Ô∏è All JS files unchanged, skipping push"
            exit 0
          fi

          cd "$CLONE_DIR"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add "$TARGET_DIR/regulation.js" "$TARGET_DIR/normative.js" "$TARGET_DIR/specification.js"
          git diff --staged --quiet || {
            git commit -m "chore(ccar): sync regulation data $(date +'%Y-%m-%d')"
            git push
            echo "üöÄ Pushed to FlightToolbox ‚Üí WeChat CI will auto-trigger"
          }

      - name: Upload downloaded files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: downloaded-regulations-${{ github.run_number }}
          path: downloads/
          retention-days: 30
          if-no-files-found: ignore

      # Clean up old workflow runs
      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 10
          keep_minimum_runs: 6
