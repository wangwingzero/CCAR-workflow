name: CAAC Regulation Update Check

on:
  schedule:
    # Daily at UTC 7:00 (Beijing Time 15:00)
    # Beijing Time = UTC + 8
    #   Beijing 8:00  → UTC 0:00  → cron: '0 0 * * *'
    #   Beijing 15:00 → UTC 7:00  → cron: '0 7 * * *'
    #   Beijing 20:00 → UTC 12:00 → cron: '0 12 * * *'
    - cron: '0 7 * * *'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      categories:
        description: |
          要监控的分类ID（逗号分隔），留空 = 全部分类
          ┌─────┬──────────────────┐
          │ ID  │ 分类名称         │
          ├─────┼──────────────────┤
          │  9  │ 通知公告         │
          │ 10  │ 政策发布         │
          │ 11  │ 政策解读         │
          │ 12  │ 统计数据         │
          │ 47  │ 法律法规         │
          │ 13  │ 民航规章         │
          │ 14  │ 规范性文件       │
          │ 15  │ 标准规范         │
          │ 16  │ 对外关系         │
          │ 17  │ 港澳台合作       │
          │ 18  │ 国际公约         │
          │ 19  │ 人事信息         │
          │ 20  │ 财政信息         │
          │ 21  │ 发展规划         │
          │ 22  │ 重大项目         │
          │ 23  │ 行政权力         │
          │ 24  │ 政府公文         │
          │ 25  │ 机构职能         │
          │ 26  │ 对外政策         │
          │ 27  │ 执法典型案例     │
          │ 28  │ 建议提案答复     │
          │ 29  │ 政府网站年度报表 │
          └─────┴──────────────────┘
          示例: 9,13,14,15
        required: false
        type: string
        default: ''
      days:
        description: |
          发送最近 N 天内的文件（0 或留空 = 增量检测新文件）
        required: false
        type: string
        default: ''
      notify:
        description: '是否强制发送通知: 1=始终发送, 0=仅有新文件时发送'
        required: false
        type: choice
        options:
          - '1'
          - '0'
        default: '1'

# Prevent concurrent runs
concurrency:
  group: caac-check
  cancel-in-progress: true

jobs:
  check-updates:
    runs-on: ubuntu-22.04
    
    permissions:
      contents: write  # Required for committing state file
      actions: write   # Clean up old workflow runs
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Set up Python
        run: uv python install 3.12
      
      - name: Install dependencies
        run: uv sync
      
      # Install Patchright browser (anti-detection)
      # --with-deps installs system dependencies (libgbm, libasound2, etc.)
      - name: Install Patchright browsers
        run: uv run patchright install --with-deps chromium

      - name: Install wrangler
        run: npm install -g wrangler
      
      - name: Run check
        env:
          # Playwright/Patchright timeout (CI needs longer)
          PLAYWRIGHT_TIMEOUT: "60000"
          
          # Send regulations from last N days (empty = detect new)
          # 手动触发时优先用 github.event.inputs，定时任务用 secrets
          DAYS: ${{ github.event.inputs.days || secrets.DAYS }}
          
          # Notification - Email
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          
          # Notification - PushPlus
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          
          # Notification - Telegram
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

          # Cloudflare R2 (optional, for PDF hosting)
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_DOMAIN: ${{ secrets.R2_DOMAIN }}
        run: |
          # 构建命令参数
          CMD=(uv run python -m src.main)

          # --categories: 手动触发时用 github.event.inputs，定时任务用 secrets（都可选）
          CATS="${{ github.event.inputs.categories || secrets.CATEGORIES }}"
          if [ -n "$CATS" ]; then
            CMD+=(--categories "$CATS")
          fi

          # --notify: 手动触发时用 github.event.inputs，定时任务用 secrets
          CMD+=(--notify "${{ github.event.inputs.notify || secrets.NOTIFY || '1' }}")

          # 固定每个分类抓取条数，提高 JS 更新覆盖率
          CMD+=(--perpage 200)

          echo "Running: ${CMD[*]}"
          "${CMD[@]}"
      
      - name: Commit state update
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/regulations.json
          if [ -f data/downloads.json ]; then
            git add data/downloads.json
          fi
          if [ -f data/r2_uploads.json ]; then
            git add data/r2_uploads.json
          fi
          if [ -d JS ]; then
            shopt -s nullglob
            js_files=(JS/*.js)
            if [ ${#js_files[@]} -gt 0 ]; then
              git add "${js_files[@]}"
            fi
          fi
          if [ -d downloads ]; then
            git add downloads
          fi
          git diff --staged --quiet || git commit -m "chore: update regulation state $(date +'%Y-%m-%d')"
          git push
      
      - name: Upload downloaded files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: downloaded-regulations-${{ github.run_number }}
          path: downloads/
          retention-days: 30
          if-no-files-found: ignore
      
      # Clean up old workflow runs
      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 10
          keep_minimum_runs: 6
