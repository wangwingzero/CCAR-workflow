# CAAC 文件监控工具 - 个人说明

## 功能概述

监控中国民航局网站 "法定主动公开内容" 下所有分类的文件更新，自动下载 PDF 并推送通知。

### 支持的分类（21个）

| ID | 分类名称 | ID | 分类名称 |
|----|----------|----|---------| 
| 9 | 通知公告 | 18 | 国际公约 |
| 10 | 政策发布 | 19 | 人事信息 |
| 11 | 政策解读 | 20 | 财政信息 |
| 12 | 统计数据 | 21 | 发展规划 |
| 47 | 法律法规 | 22 | 重大项目 |
| 13 | 民航规章 | 23 | 行政权力 |
| 14 | 规范性文件 | 24 | 政府公文 |
| 15 | 标准规范 | 25 | 机构职能 |
| 16 | 对外关系 | 26 | 对外政策 |
| 17 | 港澳台合作 | 27 | 执法典型案例 |
| | | 28 | 建议提案答复 |
| | | 29 | 政府网站年度报表 |

### 通知特点

- 按分类分组显示新增文件
- 每个分类有独立的颜色和图标
- PDF 文件名自动带分类前缀，如 `[民航规章]CCAR-121.pdf`

---

## 去重机制

### 两种运行模式

1. **去重模式（推荐日常使用）**
   - 不设置 `DAYS` 环境变量，或设为 `0`（空格也可）
   - 程序会用 `data/regulations.json` 记录已处理的文件
   - 下次运行时自动跳过已发送过的文件
   - 最多只发送最近 30 天内的新增文件（防止首次运行时邮件爆炸）

2. **按天数模式（手动补发用）**
   - 设置 `DAYS=30` 这样的数字
   - 只按发布日期过滤，不做去重
   - 不会更新状态文件
   - 适合手动补发历史数据

### GitHub Actions 配置

要启用去重模式，有两种方法：

1. **删除 DAYS secret**（推荐）
   - Settings → Secrets and variables → Actions
   - 找到 DAYS，点删除

2. **DAYS 设为 0 或空格**
   - 0 会被当作“去重模式”
   - 空格会导致转换失败，程序也会走去重模式

### 状态文件

`data/regulations.json` 存储了：
- `last_check`: 上次检查时间
- `documents`: 按分类存储的已知文件列表（按 URL 去重）

**注意**：这个文件需要提交到 GitHub，否则每次 Actions 运行都是全新状态，无法去重。

---

## 命令行参数

```bash
# 查看所有可用分类
uv run python -m src.main --list-categories

# 监控所有分类（默认）
uv run python -m src.main

# 只监控特定分类（用逗号分隔 ID）
uv run python -m src.main --categories 13,14,15

# 获取最近 N 天的文件（不去重）
uv run python -m src.main --days 7

# 每个分类爬取的数量（默认 50）
uv run python -m src.main --perpage 100

# 不下载 PDF
uv run python -m src.main --no-download

# 不发送通知
uv run python -m src.main --no-notify

# 试运行（不更新状态文件）
uv run python -m src.main --dry-run

# 发送空通知（默认已开启，可用 --notify 0 关闭）
uv run python -m src.main --notify 1
```

### 常用组合

```bash
# 日常监控（去重 + 下载 + 通知）
uv run python -m src.main

# 只监控规章类（民航规章、规范性文件、标准规范）
uv run python -m src.main --categories 13,14,15

# 测试爬取（不下载、不通知、不更新状态）
uv run python -m src.main --no-download --no-notify --dry-run

# 手动补发最近 7 天的文件
uv run python -m src.main --days 7
```

---

## 环境变量

```bash
# 邮件通知
EMAIL_USER=your@email.com
EMAIL_PASS=your_password
EMAIL_TO=a@example.com,b@example.com  # 可选，支持多人（逗号分隔），不填则默认发给 EMAIL_USER 自己
EMAIL_SENDER=CAAC 文件监控            # 可选，发件人名称

# PushPlus 通知（微信推送）
PUSHPLUS_TOKEN=your_token

# Telegram 通知
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_CHAT_ID=your_chat_id

# 默认天数限制（不设置或设为 0 则走去重模式）
DAYS=7
```

---

## GitHub Actions 配置

### 一、设置 Secrets（定时任务使用）

进入仓库页面：**Settings → Secrets and variables → Actions → Secrets tab → New repository secret**

按下面的 JSON 照着填（Name 和 Secret 一一对应），不需要的通知渠道整行跳过即可：

```json
{
  "===== 邮件通知（至少配一种通知渠道） =====": "",
  "EMAIL_USER":       "your@qq.com",
  "EMAIL_PASS":       "abcdefghijklmnop",
  "EMAIL_TO":         "收件人1@qq.com,收件人2@163.com",
  "EMAIL_SENDER":     "CAAC 文件监控",

  "===== PushPlus 微信推送（至少配一种通知渠道） =====": "",
  "PUSHPLUS_TOKEN":   "你的pushplus token",

  "===== Telegram（至少配一种通知渠道） =====": "",
  "TELEGRAM_BOT_TOKEN": "123456789:AAHxxxxxxxxxxxxxxxxxxxxxxxx",
  "TELEGRAM_CHAT_ID":   "123456789",

  "===== 运行参数（都是可选的） =====": "",
  "DAYS":             "",
  "NOTIFY":           "1",
  "CATEGORIES":       ""
}
```

**逐项说明：**

| Name（照抄） | 填什么 | 必填？ |
|-------------|--------|-------|
| `EMAIL_USER` | 发件邮箱地址 | 至少配一种通知 |
| `EMAIL_PASS` | 邮箱**授权码**（不是登录密码！QQ邮箱/163邮箱都要去设置里开启并生成） | 至少配一种通知 |
| `EMAIL_TO` | 收件人邮箱，多人用逗号隔开。不填 = 发给 `EMAIL_USER` 自己 | 可选 |
| `EMAIL_SENDER` | 邮件里显示的发件人名称 | 可选 |
| `PUSHPLUS_TOKEN` | 去 [pushplus.plus](https://www.pushplus.plus/) 注册后拿到的 token | 至少配一种通知 |
| `TELEGRAM_BOT_TOKEN` | 找 @BotFather 创建 Bot 后拿到的 token | 至少配一种通知 |
| `TELEGRAM_CHAT_ID` | 你的 Telegram 用户/群组 ID | 与上面配套 |
| `DAYS` | 填数字如 `7` = 发最近7天的文件；留空或 `0` = 去重模式（推荐） | 可选 |
| `NOTIFY` | `1` = 始终发送通知；`0` = 仅有新文件时才发 | 可选，默认 `1` |
| `CATEGORIES` | 要监控的分类 ID，逗号隔开，如 `9,13,14,15`；留空 = 全部21个分类 | 可选 |

> **提示**：通知渠道（邮件 / PushPlus / Telegram）至少配一种，可以同时配多种，会并行发送。

### 二、手动触发 Workflow（按需选择参数）

进入仓库页面：**Actions → CAAC Regulation Update Check → Run workflow**

手动触发时会出现 3 个输入框：

| 输入项 | 说明 | 填写示例 |
|-------|------|---------|
| **categories** | 要监控的分类 ID（逗号分隔），留空 = 全部分类 | `13,14,15` |
| **days** | 发送最近 N 天内的文件，留空或 `0` = 增量去重模式 | `7` |
| **notify** | 下拉选择：`1`=始终发送通知，`0`=仅有新文件时发送 | `1` |

**分类 ID 对照表**（手动触发页面也会显示）：

| ID | 分类名称 | ID | 分类名称 |
|----|----------|----|---------| 
| 9 | 通知公告 | 18 | 国际公约 |
| 10 | 政策发布 | 19 | 人事信息 |
| 11 | 政策解读 | 20 | 财政信息 |
| 12 | 统计数据 | 21 | 发展规划 |
| 47 | 法律法规 | 22 | 重大项目 |
| 13 | 民航规章 | 23 | 行政权力 |
| 14 | 规范性文件 | 24 | 政府公文 |
| 15 | 标准规范 | 25 | 机构职能 |
| 16 | 对外关系 | 26 | 对外政策 |
| 17 | 港澳台合作 | 27 | 执法典型案例 |
| | | 28 | 建议提案答复 |
| | | 29 | 政府网站年度报表 |

### 三、优先级规则

手动触发时填的值 **优先于** Secrets 中的值：

- `inputs.categories` > `secrets.CATEGORIES` > 全部分类
- `inputs.days` > `secrets.DAYS` > 去重模式
- `inputs.notify` > `secrets.NOTIFY` > 默认 `1`

也就是说：
- **定时任务**（每天北京时间 15:00）→ 使用 Secrets 中的配置
- **手动触发** → 使用你在页面上填的值，没填的项回退到 Secrets

### 四、常用场景

| 场景 | 怎么操作 |
|------|---------|
| 每天自动监控全部分类 | 不设 `CATEGORIES` secret，保持默认 |
| 每天只监控规章类 | 添加 secret `CATEGORIES` = `13,14,15` |
| 手动补发最近 7 天的文件 | 手动触发，days 填 `7` |
| 手动只查通知公告 | 手动触发，categories 填 `9` |
| 测试通知是否正常 | 手动触发，categories 填 `9`，days 填 `1` |

---

## 常见问题

### Q: 为什么同一个文件被重复下载？
A: 检查是否设置了 `DAYS` 环境变量。设置了就不会去重。

### Q: 首次运行会发送多少邮件？
A: 最多发送最近 30 天内的新增文件，不会把历史全发一遍。

### Q: 如何手动补发某段时间的文件？
A: 临时设置 `DAYS=N`（N 是天数），运行一次，然后改回去。

### Q: 如何只监控特定分类？
A: 使用 `--categories` 参数，如 `--categories 13,14,15` 只监控民航规章、规范性文件、标准规范。

### Q: 如何查看所有分类 ID？
A: 运行 `uv run python -m src.main --list-categories`

### Q: 为什么有些文件没有下载 PDF？
A: 不是所有文件都有 PDF 附件，程序会自动检测并只下载有 PDF 的文件。

### Q: 文件名为什么有 `[通知公告]` 这样的前缀？
A: 这是分类标识，方便你知道文件来自哪个板块。

---

## 文件结构

```
├── src/
│   ├── main.py      # 主程序入口
│   ├── crawler.py   # 爬虫模块（支持 21 个分类）
│   ├── storage.py   # 状态存储（按分类去重）
│   └── notifier.py  # 通知模块（按分类分组）
├── data/
│   └── regulations.json  # 状态文件（需提交到 Git）
├── downloads/          # PDF 下载目录
└── .github/
    └── workflows/      # GitHub Actions 配置
```
